services:
  app:
    restart: unless-stopped
    image: docker.io/nextcloud:${NEXTCLOUD_TAG:-latest}
    container_name: nextcloud-app
    hostname: nextcloud-app
    labels:
      diun.enable: true
      diun.watch_repos: true
      traefik.enable: true
      traefik.http.routers.nextcloud.tls: true
      traefik.http.routers.nextcloud.entrypoints: websecure
      traefik.http.routers.nextcloud.middlewares: authelia@docker
      traefik.http.routers.nextcloud.rule: Host(`cloud.${PERSONAL_DOMAIN_NAME}`)
      traefik.http.routers.nextcloud.service: nextcloud
      traefik.http.services.nextcloud.loadBalancer.server.port: 80
    environment:
      NEXTCLOUD_ADMIN_USER: ${NEXTCLOUD_ADMIN_USER}
      NEXTCLOUD_ADMIN_PASSWORD: ${NEXTCLOUD_ADMIN_PASSWORD}
      NEXTCLOUD_TRUSTED_DOMAINS: "cloud.${PERSONAL_DOMAIN_NAME} ${NEXTCLOUD_TRUSTED_DOMAINS}"
      TRUSTED_PROXIES: ${TRUSTED_PROXIES}
      POSTGRES_HOST: nextcloud-postgres:5432
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      REDIS_HOST: nextcloud-redis
      REDIS_HOST_PASSWORD: ${REDIS_PASSWORD}
    volumes:
      - /${DOCKER_DATA_DIRECTORY:?data path is required}/docker/docker-data/nextcloud/app:/var/www/html
    ports:
      - ${PERSONAL_NEXTCLOUD_PORT}:80
    networks:
      - nextcloud
      - webinternal
  postgres:
    restart: unless-stopped
    image: docker.io/postgres:${POSTGRES_TAG:-17.6-bookworm}
    container_name: nextcloud-postgres
    hostname: nextcloud-postgres
    labels:
      diun.enable: true
      diun.watch_repos: true
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - /${DOCKER_DATA_DIRECTORY:?data path is required}/docker/docker-data/nextcloud/db:/var/lib/postgresql/data
    networks:
      - nextcloud

  redis:
    restart: unless-stopped
    image: docker.io/redis:alpine
    container_name: nextcloud-redis
    hostname: nextcloud-redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - /${DOCKER_DATA_DIRECTORY:?data path is required}/docker/docker-data/nextcloud/redis:/data
    networks:
      - nextcloud

networks:
  nextcloud:
    name: nextcloud
    internal: true
  webinternal:
    name: webinternal